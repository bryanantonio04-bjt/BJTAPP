<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>BJT Solution | Control Panel</title>
  <style>
    /* Paleta de colores oficial BJT */
    :root {
      --fondo: #333333;
      --oliva: #556b2f;
      --amarillo: #ffd35b;
      --blanco: #ffffff;
      --gris: #efefed;
      --card: #444444;
    }

    body {
      background-color: var(--fondo);
      color: var(--gris);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 40px;
    }

    /* Header Estilo Apple */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto 50px;
    }

    .logo-box { display: flex; align-items: center; gap: 20px; }
    .logo-img { width: 70px; height: 70px; border-radius: 15px; background: #fff; object-fit: contain; padding: 5px; }

    nav { background: rgba(255,255,255,0.05); padding: 5px; border-radius: 15px; display: flex; }
    nav button {
      background: transparent; border: none; color: #888; padding: 10px 25px;
      cursor: pointer; font-weight: 600; border-radius: 12px; transition: 0.2s;
    }
    nav button.active { background: rgba(255,255,255,0.1); color: var(--amarillo); }

    /* Kanban */
    .kanban { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; }
    .column { background: rgba(0,0,0,0.2); min-width: 250px; border-radius: 20px; padding: 15px; }
    .col-header { font-size: 10px; font-weight: 800; color: var(--amarillo); opacity: 0.6; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }

    .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--oliva); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .card select { background: #222; color: #fff; border: none; width: 100%; margin-top: 10px; padding: 5px; border-radius: 5px; font-size: 10px; }

    .meta {
      font-size: 10px;
      opacity: 0.65;
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--gris);
      font-size: 10px;
      white-space: nowrap;
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .btn-del {
      background: none;
      border: 1px solid #555;
      color: #aaa;
      padding: 6px 8px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 10px;
      whitespace: nowrap;
    }
    .btn-del:hover { opacity: 0.8; }

    /* Facturas */
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; max-width: 1200px; margin: 0 auto; }
    .stat-box { background: rgba(255,255,255,0.03); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); }
    .amount { font-size: 35px; font-weight: 200; margin: 15px 0; }

    .inv-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid #333;
      opacity: 0.85;
      font-size: 11px;
    }
    .inv-info { flex: 1; min-width: 0; }
    .inv-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .inv-sub { font-size: 10px; opacity: 0.55; margin-top: 4px; }

    .inv-actions { display:flex; gap:8px; align-items:center; }
    .inv-actions select {
      width: auto;
      padding: 6px 8px;
      margin: 0;
      border-radius: 10px;
      font-size: 10px;
      background: #222;
      border: 1px solid #444;
      color: #fff;
    }

    /* Botones y Modales */
    .btn-main { background: var(--oliva); color: white; border: none; padding: 12px 25px; border-radius: 12px; font-weight: 600; cursor: pointer; margin-bottom: 20px; }
    .btn-main:hover { opacity: 0.8; }

    .toolbar {
      max-width: 1200px;
      margin: 0 auto 18px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 100; }
    .modal-content { background: #222; padding: 40px; border-radius: 25px; width: 370px; border: 1px solid #444; }
    input, select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; background: #333; border: 1px solid #444; color: white; border-radius: 10px; box-sizing: border-box; }

    .hint {
      font-size: 10px;
      opacity: 0.5;
      margin-top: -8px;
      margin-bottom: 12px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--amarillo);
      font-size: 14px;
    }

    .sync-badge {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(85, 107, 47, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 11px;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 50;
    }
  </style>
</head>
<body>

  <div class="sync-badge" id="sync-badge">☁️ Sincronizado</div>

  <header>
    <div class="logo-box">
      <img src="Logo BJT final.jpg" class="logo-img" alt="BJT" onerror="this.style.display='none'">
      <div>
        <h2 style="margin:0">BJT Solution</h2>
        <div style="font-size:9px; opacity:0.4; letter-spacing:2px">GESTIÓN EMPRESARIAL</div>
      </div>
    </div>
    <nav>
      <button onclick="changeTab('tareas')" id="btn-tareas" class="active">Tareas</button>
      <button onclick="changeTab('facturas')" id="btn-facturas">Facturación</button>
      <button onclick="changeTab('clientes')" id="btn-clientes">Clientes</button>
    </nav>
  </header>

  <div id="loading-screen" class="loading">Cargando datos...</div>

  <!-- TAREAS -->
  <div id="view-tareas" style="display:none">
    <div class="toolbar">
      <button class="btn-main" onclick="openModal('tarea')">+ Nueva Tarea</button>
    </div>
    <div class="kanban" id="kanban-board"></div>
  </div>

  <!-- FACTURAS -->
  <div id="view-facturas" style="display:none">
    <div class="toolbar" style="justify-content:flex-start; max-width:1200px; margin:0 auto 18px;">
      <button class="btn-main" onclick="openModal('factura')" style="background:var(--amarillo); color:#000">Nueva Factura</button>
    </div>
    <div class="grid-3" id="invoice-board"></div>
  </div>

  <!-- CLIENTES -->
  <div id="view-clientes" style="display:none">
    <button class="btn-main" onclick="openModal('cliente')">+ Agregar Cliente</button>
    <button onclick="exportarCSV()" style="background:none; color:#888; border:1px solid #555; padding:10px; border-radius:10px; cursor:pointer; margin-left:10px">Exportar CSV</button>
    <div id="clients-list" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:20px; margin-top:20px"></div>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="modal-title" style="color:var(--amarillo)">AÑADIR</h3>
      <div id="modal-fields"></div>
      <div style="display:flex; gap:10px; margin-top:15px">
        <button onclick="closeModal()" style="background:none; border:none; color:#777; cursor:pointer; flex:1">Cerrar</button>
        <button onclick="save()" style="background:var(--oliva); color:white; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:bold; flex:1">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // =========================================
    // CONFIG: Google Apps Script Web App URL
    // =========================================
    const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbxylg1tPkCfmE8sYzuIlBwtk9qGX3QOTr6FKXel99tgpGRvgzjwJ67_llhsCS4A27XI/exec";

    // =========================
    // Helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    const STAGES = ["to-do", "in progress", "work on it", "pending 3 party", "cancelled", "done"];

    const uid = () =>
      (crypto?.randomUUID?.() ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));

    // =========================
    // Sync Badge
    // =========================
    function showSyncBadge() {
      const badge = $('sync-badge');
      badge.style.display = 'flex';
      setTimeout(() => {
        badge.style.display = 'none';
      }, 2000);
    }

    // =========================
    // Google Sheets DB (Apps Script)
    // =========================
    async function apiGet(url) {
      const res = await fetch(url, { method: "GET" });
      if (!res.ok) throw new Error("GET failed: " + res.status);
      return await res.json();
    }

    async function apiPost(url, payload) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("POST failed: " + res.status);
      return await res.json();
    }

    async function loadDB() {
      const out = await apiGet(`${SHEETS_API_URL}?action=load`);
      if (!out.ok) throw new Error(out.error || "Error cargando DB");

      const data = out.data || { clients: [], tasks: [], invoices: [] };

      data.invoices = (data.invoices || []).map(i => ({ ...i, m: Number(i.m || 0) }));

      return {
        clients: Array.isArray(data.clients) ? data.clients : [],
        tasks: Array.isArray(data.tasks) ? data.tasks : [],
        invoices: Array.isArray(data.invoices) ? data.invoices : [],
      };
    }

    async function saveDB() {
      const out = await apiPost(SHEETS_API_URL, { action: "save", data: db });
      if (!out.ok) {
        alert("Error al guardar: " + (out.error || "desconocido"));
        return false;
      }
      showSyncBadge();
      return true;
    }

    function clientNameById(id) {
      if (!id) return "";
      const c = db.clients.find(x => String(x.id) === String(id));
      return c ? c.n : "";
    }

    function buildClientSelect(selectId, selectedClientId = "") {
      const select = document.createElement("select");
      select.id = selectId;

      const optNone = document.createElement("option");
      optNone.value = "";
      optNone.textContent = "Sin cliente (opcional)";
      select.appendChild(optNone);

      db.clients.forEach(c => {
        const o = document.createElement("option");
        o.value = c.id;
        o.textContent = c.n;
        if (String(selectedClientId) === String(c.id)) o.selected = true;
        select.appendChild(o);
      });

      return select;
    }

    // Escape CSV fields properly
    function csvField(v) {
      const s = String(v ?? "");
      if (/[",\n]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
      return s;
    }

    // =========================
    // State
    // =========================
    let db = { clients: [], tasks: [], invoices: [] };
    let activeType = "";
    let modalContext = { stage: "to-do" };

    // =========================
    // Tabs
    // =========================
    window.changeTab = function changeTab(t) {
      ["tareas", "facturas", "clientes"].forEach((v) => {
        $("view-" + v).style.display = v === t ? "block" : "none";
        $("btn-" + v).className = v === t ? "active" : "";
      });
      render();
    };

    // =========================
    // Modal
    // =========================
    window.openModal = function openModal(type, ctx = {}) {
      activeType = type;
      modalContext = { stage: "to-do", ...ctx };

      $("modal-title").innerText = "NUEVO " + type.toUpperCase();
      const f = $("modal-fields");
      f.innerHTML = "";

      if (type === "cliente") {
        f.innerHTML = `
          <input id="i1" placeholder="Nombre" autocomplete="name">
          <input id="i2" placeholder="Email" autocomplete="email">
        `;
      }

      if (type === "tarea") {
        const ta = document.createElement("textarea");
        ta.id = "i1";
        ta.placeholder = "Descripción de la tarea";
        ta.rows = 3;

        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "Podés ligarla a un cliente (opcional)";

        const sel = buildClientSelect("i2", "");

        f.appendChild(ta);
        f.appendChild(hint);
        f.appendChild(sel);
      }

      if (type === "factura") {
        const ref = document.createElement("input");
        ref.id = "i1";
        ref.placeholder = "Nº de Referencia";

        const monto = document.createElement("input");
        monto.id = "i2";
        monto.type = "number";
        monto.placeholder = "Monto $";
        monto.min = "0";
        monto.step = "0.01";

        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "Cliente opcional (podés dejarlo en blanco)";

        const clientSel = buildClientSelect("i4", "");

        const estado = document.createElement("select");
        estado.id = "i3";
        estado.innerHTML = `
          <option value="p">Por Cobrar</option>
          <option value="pag">Pagada</option>
          <option value="can">Cancelada</option>
        `;

        f.appendChild(ref);
        f.appendChild(monto);
        f.appendChild(hint);
        f.appendChild(clientSel);
        f.appendChild(estado);
      }

      $("modal").style.display = "flex";
      setTimeout(() => $("i1")?.focus(), 0);
    };

    window.closeModal = function closeModal() {
      $("modal").style.display = "none";
    };

    $("modal").addEventListener("click", (e) => {
      if (e.target.id === "modal") closeModal();
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    window.save = async function save() {
      const v1 = $("i1")?.value?.trim();
      const v2 = $("i2")?.value?.trim();
      const v3 = $("i3")?.value;
      const v4 = $("i4")?.value;

      if (!v1) return alert("El campo principal es obligatorio");

      const now = new Date().toISOString();

      if (activeType === "cliente") {
        db.clients.push({ id: uid(), n: v1, e: v2 || "", createdAt: now });
      }

      if (activeType === "tarea") {
        const clientId = $("i2")?.value || "";
        db.tasks.push({
          id: uid(),
          t: v1,
          s: modalContext.stage || "to-do",
          cId: clientId || "",
          createdAt: now
        });
      }

      if (activeType === "factura") {
        const monto = Number($("i2")?.value || 0);
        const clientId = $("i4")?.value || "";
        db.invoices.push({
          id: uid(),
          r: v1,
          m: isFinite(monto) ? monto : 0,
          s: v3 || "p",
          cId: clientId || "",
          createdAt: now
        });
      }

      closeModal();
      await saveDB();
      render();
    };

    // =========================
    // Render
    // =========================
    function render() {
      renderKanban();
      renderInvoices();
      renderClients();
    }

    function renderKanban() {
      const board = $("kanban-board");
      board.innerHTML = "";

      STAGES.forEach((stage) => {
        const col = document.createElement("div");
        col.className = "column";

        const header = document.createElement("div");
        header.className = "col-header";
        header.textContent = stage;

        const list = document.createElement("div");

        db.tasks
          .filter((t) => t.s === stage)
          .forEach((t) => {
            const card = document.createElement("div");
            card.className = "card";

            const p = document.createElement("p");
            p.textContent = t.t;
            card.appendChild(p);

            const meta = document.createElement("div");
            meta.className = "meta";

            const cname = clientNameById(t.cId);
            const badge = document.createElement("div");
            badge.className = "badge";
            badge.textContent = "Cliente: " + (cname || "Sin cliente");
            meta.appendChild(badge);

            const del = document.createElement("button");
            del.className = "btn-del";
            del.textContent = "Borrar";
            del.addEventListener("click", () => {
              const ok = confirm("¿Borrar esta tarea?");
              if (!ok) return;
              deleteTask(t.id);
            });
            meta.appendChild(del);

            card.appendChild(meta);

            const sel = document.createElement("select");
            STAGES.forEach((opt) => {
              const o = document.createElement("option");
              o.value = opt;
              o.textContent = opt;
              if (opt === stage) o.selected = true;
              sel.appendChild(o);
            });
            sel.addEventListener("change", (e) => moveTask(t.id, e.target.value));
            card.appendChild(sel);

            list.appendChild(card);
          });

        col.appendChild(header);
        col.appendChild(list);
        board.appendChild(col);
      });
    }

    function renderInvoices() {
      const fin = $("invoice-board");
      if (!fin) return;

      const total = (st) =>
        db.invoices
          .filter((i) => i.s === st)
          .reduce((acc, v) => acc + Number(v.m || 0), 0);

      fin.innerHTML = "";

      const groups = [
        { l: "Por Cobrar", s: "p", c: "var(--amarillo)" },
        { l: "Pagadas", s: "pag", c: "var(--oliva)" },
        { l: "Canceladas", s: "can", c: "#ff4444" },
      ];

      groups.forEach((g) => {
        const box = document.createElement("div");
        box.className = "stat-box";

        const title = document.createElement("div");
        title.style.fontSize = "10px";
        title.style.opacity = "0.4";
        title.style.fontWeight = "bold";
        title.textContent = g.l.toUpperCase();

        const amt = document.createElement("div");
        amt.className = "amount";
        amt.style.color = g.c;
        amt.textContent =
          "$" + total(g.s).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 });

        box.appendChild(title);
        box.appendChild(amt);

        const list = db.invoices.filter((i) => i.s === g.s);

        if (list.length === 0) {
          const empty = document.createElement("div");
          empty.style.fontSize = "11px";
          empty.style.opacity = "0.4";
          empty.style.paddingTop = "6px";
          empty.textContent = "Sin facturas en esta categoría.";
          box.appendChild(empty);
        } else {
          list.forEach((inv) => {
            const row = document.createElement("div");
            row.className = "inv-row";

            const info = document.createElement("div");
            info.className = "inv-info";

            const line1 = document.createElement("div");
            line1.className = "inv-title";
            line1.textContent = `#${inv.r} — $${Number(inv.m || 0).toLocaleString(undefined, { maximumFractionDigits: 2 })}`;

            const cname = clientNameById(inv.cId);
            const line2 = document.createElement("div");
            line2.className = "inv-sub";
            line2.textContent = cname ? `Cliente: ${cname}` : "Cliente: (sin asignar)";

            info.appendChild(line1);
            info.appendChild(line2);

            const actions = document.createElement("div");
            actions.className = "inv-actions";

            const stSel = document.createElement("select");
            [
              {v:"p", l:"Por cobrar"},
              {v:"pag", l:"Pagada"},
              {v:"can", l:"Cancelada"},
            ].forEach(opt => {
              const o = document.createElement("option");
              o.value = opt.v;
              o.textContent = opt.l;
              if (opt.v === inv.s) o.selected = true;
              stSel.appendChild(o);
            });
            stSel.addEventListener("change", (e) => moveInvoice(inv.id, e.target.value));

            const del = document.createElement("button");
            del.className = "btn-del";
            del.textContent = "Borrar";
            del.addEventListener("click", () => {
              const ok = confirm("¿Borrar esta factura?");
              if (!ok) return;
              deleteInvoice(inv.id);
            });

            actions.appendChild(stSel);
            actions.appendChild(del);

            row.appendChild(info);
            row.appendChild(actions);

            box.appendChild(row);
          });
        }

        fin.appendChild(box);
      });
    }

    function renderClients() {
      const cl = $("clients-list");
      if (!cl) return;

      cl.innerHTML = "";
      db.clients.forEach((c) => {
        const box = document.createElement("div");
        box.className = "stat-box";
        box.style.padding = "20px";

        const name = document.createElement("div");
        name.style.fontWeight = "bold";
        name.style.color = "var(--amarillo)";
        name.style.marginBottom = "5px";
        name.textContent = c.n;

        const email = document.createElement("div");
        email.style.fontSize = "11px";
        email.style.opacity = "0.4";
        email.textContent = c.e || "";

        box.appendChild(name);
        box.appendChild(email);
        cl.appendChild(box);
      });
    }

    // =========================
    // Actions
    // =========================
    window.moveTask = async function moveTask(id, ns) {
      db.tasks = db.tasks.map((t) => (t.id === id ? { ...t, s: ns } : t));
      await saveDB();
      render();
    };

    window.deleteTask = async function deleteTask(id) {
      db.tasks = db.tasks.filter(t => t.id !== id);
      await saveDB();
      render();
    };

    window.moveInvoice = async function moveInvoice(id, ns) {
      db.invoices = db.invoices.map((i) => (i.id === id ? { ...i, s: ns } : i));
      await saveDB();
      render();
    };

    window.deleteInvoice = async function deleteInvoice(id) {
      db.invoices = db.invoices.filter(i => i.id !== id);
      await saveDB();
      render();
    };

    window.exportarCSV = function exportarCSV() {
      const header = ["Nombre", "Email"].map(csvField).join(",");
      const rows = db.clients.map((c) => [csvField(c.n), csvField(c.e)].join(","));
      const csv = "\uFEFF" + header + "\n" + rows.join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "clientes_bjt.csv";
      a.click();
      URL.revokeObjectURL(a.href);
    };

    // =========================
    // Init
    // =========================
    async function init() {
      try {
        db = await loadDB();
        $('loading-screen').style.display = 'none';
        changeTab('tareas');
        render();
      } catch (error) {
        console.error('Error loading data:', error);
        $('loading-screen').innerHTML = 'Error al cargar datos. Por favor recarga la página.';
      }
    }

    init();
  </script>
</body>
</html>

